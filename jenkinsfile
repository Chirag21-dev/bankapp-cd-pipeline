pipeline {
    agent any
    environment {
          IMAGE_NAME = "bankappci"
          //RELEASE = "1.0.0"
          TAG = "${env.BUILD_NUMBER}"
          KUBE_NAMESPACE = "webapps"
    }

    /*parameters {
     password(name: 'PASSWD', defaultValue: '', description: 'Please Enter your Gitlab password or token')
     string(name: 'IMAGE_TAG', defaultValue: '1', description: 'Please Enter the Image Tag to Deploy?')
     //choice(name:'environment', choices: ['functional', 'integration', 'regression', 'uat', 'release' ] ,description: 'select where need to deploy')
    }*/

    stages {
         stage("Cleanup Workspace") {
             steps {
                cleanWs()
             }
         }
         stage("Checkout from SCM") {
             steps {
                     git branch: 'main', credentialsId: 'github', url: 'https://github.com/Chirag21-dev/bankapp-cd-pipeline.git'
             }
         }
         stage("Update the Deployment Tags") {
            steps {
                dir('Manifests'){
                    sh """
                    cat bankapp.yaml
                    sed -i "s|image: chiragks1/bankappci:.*|image: chiragks1/bankappci:${TAG}|g" bankapp.yaml

                    cat bankapp.yaml
                """
                }     
            }
         }
         stage("Push the changed deployment file to GitHub") {
            steps {
               withCredentials([gitUsernamePassword(credentialsId: 'github', gitToolName: 'Default')]) {
               sh """
                    git config --global user.name "chirag21-dev"
                    git config --global user.email "chiragks@gmail.com"
                    git add Manifests/bankapp.yaml
                    git commit -m "Updated Deployment Manifest"
                    git push https://github.com/Chirag21-dev/bankapp-cd-pipeline.git 
                """
}
    }
         }
         stage('Deploy MySQL Deployment and Service') {
            steps {
                dir('Manifests'){
                  script {
                    kubeconfig(credentialsId: 'k8s-token', serverUrl: 'https://3370DF416F397B0970B2CDC7088432E8.yl4.us-east-2.eks.amazonaws.com') {
                        sh "kubectl apply -f bankapp.yml -n ${KUBE_NAMESPACE}" 
                        sh 'kubectl apply -f database.yaml -n ${KUBE_NAMESPACE}' // Ensure you have the MySQL deployment YAML ready
                    }  
                }
                
            }
        }
         
    }
}
}


